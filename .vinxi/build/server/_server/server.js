import{AsyncLocalStorage as U}from"node:async_hooks";import{H3Event as _,getRequestURL as W,getRequestWebStream as J,getResponseStatus as B,eventHandler as G}from"h3";function b(e){if(!F(e))return!1;const t=e.constructor;if(typeof t>"u")return!0;const n=t.prototype;return!(!F(n)||!n.hasOwnProperty("isPrototypeOf"))}function F(e){return Object.prototype.toString.call(e)==="[object Object]"}function j(e){return!!e?.isRedirect}function L(e){return!!e?.isNotFound}var K="Invariant failed";function V(e,t){if(!e)throw new Error(K)}const l={stringify:e=>JSON.stringify(e,function(n,r){const o=this[n],a=S.find(s=>s.stringifyCondition(o));return a?a.stringify(o):r}),parse:e=>JSON.parse(e,function(n,r){const o=this[n];if(b(o)){const a=S.find(s=>s.parseCondition(o));if(a)return a.parse(o)}return r}),encode:e=>{if(Array.isArray(e))return e.map(n=>l.encode(n));if(b(e))return Object.fromEntries(Object.entries(e).map(([n,r])=>[n,l.encode(r)]));const t=S.find(n=>n.stringifyCondition(e));return t?t.stringify(e):e},decode:e=>{if(b(e)){const t=S.find(n=>n.parseCondition(e));if(t)return t.parse(e)}return Array.isArray(e)?e.map(t=>l.decode(t)):b(e)?Object.fromEntries(Object.entries(e).map(([t,n])=>[t,l.decode(n)])):e}},y=(e,t,n,r)=>({key:e,stringifyCondition:t,stringify:o=>({[`$${e}`]:n(o)}),parseCondition:o=>Object.hasOwn(o,`$${e}`),parse:o=>r(o[`$${e}`])}),S=[y("undefined",e=>e===void 0,()=>0,()=>{}),y("date",e=>e instanceof Date,e=>e.toISOString(),e=>new Date(e)),y("error",e=>e instanceof Error,e=>({...e,message:e.message,stack:void 0,cause:e.cause}),e=>Object.assign(new Error(e.message),e)),y("formData",e=>e instanceof FormData,e=>{const t={};return e.forEach((n,r)=>{const o=t[r];o!==void 0?Array.isArray(o)?o.push(n):t[r]=[o,n]:t[r]=n}),t},e=>{const t=new FormData;return Object.entries(e).forEach(([n,r])=>{Array.isArray(r)?r.forEach(o=>t.append(n,o)):t.append(n,r)}),t}),y("bigint",e=>typeof e=="bigint",e=>e.toString(),e=>BigInt(e))],Q=[];function X(e){Q.push(...e.middleware)}function p(e,t){const n=t||e||{};return{options:n,middleware:r=>p(void 0,Object.assign(n,{middleware:r})),validator:r=>p(void 0,Object.assign(n,{validator:r})),client:r=>p(void 0,Object.assign(n,{client:r})),server:r=>p(void 0,Object.assign(n,{server:r}))}}function Y(e={}){let t,n=!1;const r=s=>{if(t&&t!==s)throw new Error("Context conflict")};let o;if(e.asyncContext){const s=e.AsyncLocalStorage||globalThis.AsyncLocalStorage;s?o=new s:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const a=()=>{if(o){const s=o.getStore();if(s!==void 0)return s}return t};return{use:()=>{const s=a();if(s===void 0)throw new Error("Context is not available");return s},tryUse:()=>a(),set:(s,c)=>{c||r(s),t=s,n=!0},unset:()=>{t=void 0,n=!1},call:(s,c)=>{r(s),t=s;try{return o?o.run(s,c):c()}finally{n||(t=void 0)}},async callAsync(s,c){t=s;const w=()=>{t=s},f=()=>t===s?w:void 0;M.add(f);try{const d=o?o.run(s,c):c();return n||(t=void 0),await d}finally{M.delete(f)}}}}function Z(e={}){const t={};return{get(n,r={}){return t[n]||(t[n]=Y({...e,...r})),t[n]}}}const T=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof global<"u"?global:typeof window<"u"?window:{},q="__unctx__",k=T[q]||(T[q]=Z()),ee=(e,t={})=>k.get(e,t),D="__unctx_async_handlers__",M=T[D]||(T[D]=new Set);function te(e){let t;const n=P(e),r={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(n,{...r,body:e.node.req.body}):new Request(n,{...r,get body(){return t||(t=ie(e),t)}})}function ne(e){return e.web??(e.web={request:te(e),url:P(e)}),e.web.request}function re(){return H()}const $=Symbol("$HTTPEvent");function oe(e){return typeof e=="object"&&(e instanceof _||e?.[$]instanceof _||e?.__is_event__===!0)}function E(e){return function(...t){var n;const r=t[0];if(oe(r))t[0]=r instanceof _||r.__is_event__?r:r[$];else{if(!((n=globalThis.app.config.server.experimental)!=null&&n.asyncContext))throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");t.unshift(re())}return e(...t)}}const P=E(W),se=E(B),ie=E(J);function ae(){var e;return ee("nitro-app",{asyncContext:!!((e=globalThis.app.config.server.experimental)!=null&&e.asyncContext),AsyncLocalStorage:U})}function H(){const e=ae().use().event;if(!e)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");return e}const ce={},fe=p().client(async e=>{const t=new Date;return e.next({context:{clientTime:t},sendContext:{clientTime:t}})}).server(async e=>{const t=new Date;return e.next({sendContext:{serverTime:t,durationToServer:t.getTime()-e.context.clientTime.getTime()}})}),ue=p().middleware([fe]).client(async e=>{const t=await e.next(),n=new Date;return console.log("Client Req/Res:",{duration:t.context.clientTime.getTime()-n.getTime(),durationToServer:t.context.durationToServer,durationFromServer:n.getTime()-t.context.serverTime.getTime()}),t});X({middleware:[ue]});const we=G(le),x=ce;async function le(e){const t=ne(e);return await pe({request:t,event:e})}function de(e){return e.replace(/^\/|\/$/g,"")}async function pe({request:e,event:t}){const n=new AbortController,r=n.signal,o=()=>n.abort();t.node.req.on("close",o);const a=e.method,s=new URL(e.url,"http://localhost:3000"),c=new RegExp(`${de("/_server")}/([^/?#]+)`),w=s.pathname.match(c),f=w?w[1]:null,d=Object.fromEntries(s.searchParams.entries()),C="createServerFn"in d,I="raw"in d;if(typeof f!="string")throw new Error("Invalid server action param for serverFnId: "+f);const R=x[f];if(!R)throw console.log("serverFnManifest",x),new Error("Server function info not found for "+f);let m;if(m=await R.importer(),!m)throw console.log("serverFnManifest",x),new Error("Server function module not resolved for "+f);const g=m[R.functionName];if(!g)throw console.log("serverFnManifest",x),console.log("fnModule",m),new Error(`Server function module export not resolved for serverFn ID: ${f}`);const z=["multipart/form-data","application/x-www-form-urlencoded"],h=await(async()=>{try{let i=await(async()=>{if(e.headers.get("Content-Type")&&z.some(u=>{var A;return(A=e.headers.get("Content-Type"))==null?void 0:A.includes(u)}))return V(a.toLowerCase()!=="get","GET requests with FormData payloads are not supported"),await g(await e.formData(),r);if(a.toLowerCase()==="get"){let u=d;return C&&(u=d.payload),u=u&&l.parse(u),await g(u,r)}const v=await e.text(),O=l.parse(v);return C?await g(O,r):await g(...O,r)})();return i.result instanceof Response?i.result:!C&&(i=i.result,i instanceof Response)?i:j(i)||L(i)?N(i):new Response(i!==void 0?l.stringify(i):void 0,{status:se(H()),headers:{"Content-Type":"application/json"}})}catch(i){return i instanceof Response?i:j(i)||L(i)?N(i):(console.info(),console.info("Server Fn Error!"),console.info(),console.error(i),console.info(),new Response(l.stringify(i),{status:500,headers:{"Content-Type":"application/json"}}))}})();if(t.node.req.removeListener("close",o),I)return h;if(h.headers.get("Content-Type")==="application/json"){const v=await h.clone().text();v&&JSON.stringify(JSON.parse(v))}return h}function N(e){const{headers:t,...n}=e;return new Response(JSON.stringify(n),{status:200,headers:{"Content-Type":"application/json",...t||{}}})}export{we as default};
